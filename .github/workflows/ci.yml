name: Push a Debian package to Cloudsmith with OIDC
on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  id-token: write      # Necessary to GH Identity Provider to write the JWT token which Cloudsmith needs to read
  contents: read

jobs:
  push:
    runs-on: ubuntu-latest
    name: Push a Debian package to Cloudsmith using OIDC to authenticate
    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: Create Debian package
        run: |
          mkdir -p test/cloudsmith-debian-example-1.0.0-amd64/DEBIAN
          echo 'Package: cloudsmith-debian-example
          Version: 1.0.0
          Section: base
          Priority: optional
          Architecture: amd64
          Maintainer: Your Name <you@example.com>
          Description: This is a Cloudsmith Debian example package
          ' > test/cloudsmith-debian-example-1.0.0-amd64/DEBIAN/control
          mkdir -p test/cloudsmith-debian-example-1.0.0-amd64/usr/local/bin
          echo '#!/bin/bash\necho "Hello, Cloudsmith!"' > test/cloudsmith-debian-example-1.0.0-amd64/usr/local/bin/cloudsmith-debian-example
          chmod 755 test/cloudsmith-debian-example-1.0.0-amd64/usr/local/bin/cloudsmith-debian-example
          dpkg-deb --build test/cloudsmith-debian-example-1.0.0-amd64

      - name: Verify Debian package creation
        run: |
          ls -la test
          ls -la test/cloudsmith-debian-example-1.0.0-amd64.deb

      - name: Get OIDC token
        run: |
          echo "Requesting OIDC token"
          oidc_response=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange")
          echo "OIDC Response: $oidc_response"
          oidc_token=$(echo $oidc_response | jq -r '.value')
          echo "OIDC Token: $oidc_token"
          echo "::set-output name=oidc_token::$oidc_token"

      - name: Request Cloudsmith JWT Token
        id: get_cloudsmith_token
        run: |
          echo "Requesting Cloudsmith JWT token"
          cloudsmith_jwt=$(curl -X POST -H "Content-Type: application/json" -d "{\"oidc_token\":\"${{ steps.get_oidc_token.outputs.oidc_token }}\", \"service_slug\":\"github-actions\"}" https://api.cloudsmith.io/openid/arshad-qureshi/)
          echo "JWT Response: $cloudsmith_jwt"
          cloudsmith_token=$(echo $cloudsmith_jwt | jq -r '.token')
          echo "JWT Token: $cloudsmith_token"
          echo "CLOUDSMITH_API_KEY=$cloudsmith_token" >> $GITHUB_ENV

      - name: Cloudsmith Push Debian Package
        uses: cloudsmith-io/action@v0.5.3
        with:
          command: 'push'
          format: 'deb'
          owner: 'arshad-qureshi'             # Your Cloudsmith account name or org name (namespace)
          repo: 'github-actions'         # Your Cloudsmith Repository name (slug)
          distro: 'debian'     # Your Distribution  (i.e Debian, Ubuntu)
          release: 'buster'         # Your Distribution Release (i.e xenial, buster)
          republish: 'true'          # needed if version is not changing
          file: 'test/cloudsmith-debian-example-1.0.0-amd64.deb'  # debian package filename
